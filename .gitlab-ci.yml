
stages:
  - build
  - test
  - rust
  - coverage
  - docker
  - performance
  - report

variables:
  DOCKER_HOST: "tcp://server-custom-dind.custom-dind:2375"
  # Move cargo data into the project directory so it can be cached by the runner
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo
  RUSTFLAGS: "-Dwarnings"
  RUSTDOCFLAGS: "-Dwarnings"
  RUST_BACKTRACE: "1"
  CARGO_INCREMENTAL: "1"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

build-image:
  stage: build
  image: docker:27-cli
  script:
    - echo "Building Python + Docker client image"
    - docker build -t $CI_REGISTRY_IMAGE:latest .
    - docker build -t $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA} .
    - docker run $CI_REGISTRY_IMAGE:latest ls
    - docker run $CI_REGISTRY_IMAGE:latest /usr/local/bin/editor --help
    # Verify cargo works offline
    - docker run --net none $CI_REGISTRY_IMAGE:latest cargo build --all
  tags:
    - dind-amd

test-image:
  stage: test
  image: $CI_REGISTRY_IMAGE:latest
  needs:
    - build-image
  script:
    - uname -a
    - /usr/local/bin/editor --help
  tags:
    - dind-amd

push-image:
  stage: test
  image: docker:27-cli
  needs:
    - test-image
  script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
    - docker push $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:${CI_COMMIT_SHORT_SHA}
  only:
    - master
    - main
  tags:
    - dind-amd



rust:build-test-lint:
  before_script:
    - rustc --version
    - cargo --version
    - apt-get update -qq
    - apt-get install -y -qq curl
    - curl -L https://github.com/mozilla/grcov/releases/latest/download/grcov-x86_64-unknown-linux-gnu.tar.bz2 | tar jxf -
    - chmod +x grcov
    - rustup component add llvm-tools-preview
  image: rust:latest
  cache:
    key: "${CI_COMMIT_REF_SLUG}"
    paths:
      # Cache the cargo home directory which contains registries and bins
      - .cargo
      # Cache the build artifacts directory
      - target
    # This ensures the cache is available to all jobs in the pipeline
    policy: pull-push
  stage: rust
  script:
    # Add required components
    - rustup component add clippy rustfmt

    # Build
    - echo "===== Building Release Binaries ====="
    - cargo build --all --all-features --release
    - mkdir -p artifacts/binaries
    - cp target/release/validate-yaml artifacts/binaries/ || true
    - cp target/release/validate-json artifacts/binaries/ || true
    - cp target/release/trm artifacts/binaries/ || true
    - cp target/release/test-verify artifacts/binaries/ || true
    - cp target/release/test-executor artifacts/binaries/ || true
    - cp target/release/test-orchestrator artifacts/binaries/ || true

    # Lint - rustfmt
    - echo "===== Running rustfmt ====="
    - cargo fmt --all -- --check

    # Lint - clippy
    - echo "===== Running Clippy ====="
    - cargo clippy --all --all-features --tests -- -D warnings 2>&1 | tee clippy_output.txt

    # Test - unit tests
    - echo "===== Running Unit Tests ====="
    - cargo test --all --all-features --tests --no-fail-fast -- --test-threads=1 2>&1 | tee test_output.txt
    - python3 scripts/ci_parse_test_results.py test_output.txt > test_results.json

    # Test - e2e tests
    - echo "===== Running E2E Tests ====="
    - make test-e2e 2>&1 | tee e2e_output.txt || true

    # Test - doc tests
    - echo "===== Running Doc Tests ====="
    - cargo test --doc 2>&1 | tee doc_test_output.txt || true
    - export CARGO_INCREMENTAL=0
    - export RUSTFLAGS="-Cinstrument-coverage"
    - export LLVM_PROFILE_FILE="coverage-%p-%m.profraw"
    - cargo test --all --all-features --tests
    - ./grcov . --binary-path ./target/debug/ -s . -t lcov --branch --ignore-not-existing --ignore "/*" -o lcov.info
    - ./grcov . --binary-path ./target/debug/ -s . -t html --branch --ignore-not-existing --ignore "/*" -o coverage/html
    - |
      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
        python3 scripts/ci_compare_coverage.py lcov.info > coverage_report.json
        python3 scripts/ci_post_coverage_comment.py coverage_report.json
      fi
  after_script:
    - |
      if [ -f test_results.json ]; then
        python3 scripts/ci_post_mr_comment.py test_results.json || true
      fi
    - |
      if [ -f clippy_output.txt ] && grep -q "warning:" clippy_output.txt; then
        python3 scripts/ci_post_clippy_comment.py clippy_output.txt || true
      fi
  coverage: '/lines\.*: \d+\.\d+%/'
  artifacts:
    name: "rust-artifacts-$CI_COMMIT_REF_SLUG"
    paths:
      - lcov.info
      - coverage/
      - coverage_report.json
      - test_output.txt
      - test_results.json
      - e2e_output.txt
      - doc_test_output.txt
      - clippy_output.txt
    reports:
      junit: test_results.xml
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml
    expire_in: 1 week
    when: always

docker:build:
  stage: docker
  image: docker:27-cli
  before_script:
    - docker info
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - echo "Built image $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA"
    - docker build -t $CI_REGISTRY_IMAGE:test .
    - docker images | grep $CI_REGISTRY_IMAGE
    - docker run --rm $CI_REGISTRY_IMAGE:test validate-yaml --help
    - docker run --rm $CI_REGISTRY_IMAGE:test validate-json --help
    - echo "Image verification successful"
    - docker inspect $CI_REGISTRY_IMAGE:test | tee docker_inspect.json
  artifacts:
    name: "docker-verify-$CI_COMMIT_REF_SLUG"
    paths:
      - docker_inspect.json
    expire_in: 1 week
  tags:
    - dind-amd

docker:verify:
  stage: docker
  image: python:3.14-slim
  dependencies:
    - docker:build
  needs:
    - docker:build
  script:
    - find . || true
    - ls -la docker_inspect.json || true
    - python3 scripts/ci_docker_security_scan.py docker_inspect.json > docker_scan_results.json
  artifacts:
    name: "docker-verify-$CI_COMMIT_REF_SLUG"
    paths:
      - docker_scan_results.json
    expire_in: 1 week

docker:push:
  stage: docker
  image: docker:27-cli
  services:
    - docker:27-dind
  dependencies:
    - docker:verify
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login $CI_REGISTRY -u $CI_REGISTRY_USER --password-stdin
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE:latest
        docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
        docker push $CI_REGISTRY_IMAGE:latest
      fi
  only:
    - master
    - main
  tags:
    - dind-amd
#
#performance:baseline:
#  image: rust:1.92-bookworm
#  stage: performance
#  dependencies:
#    - rust:build-test-lint
#  before_script:
#    - rustc --version
#    - cargo --version
#    - apt-get update -qq
#  script:
#    - apt-get install -y -qq python3 python3-pip
#    - pip3 install --break-system-packages psutil
#    - python3 scripts/ci_benchmark.py --output baseline_perf.json
#  artifacts:
#    name: "performance-baseline-$CI_COMMIT_REF_SLUG"
#    paths:
#      - baseline_perf.json
#    expire_in: 1 month
#  only:
#    - master
#    - main
#
#performance:compare:
#  image: rust:1.92-bookworm
#  stage: performance
#  dependencies:
#    - rust:build-test-lint
#  before_script:
#    - rustc --version
#    - cargo --version
#    - apt-get update -qq
#  script:
#    - apt-get install -y -qq python3 python3-pip git
#    - pip3 install --break-system-packages psutil
#    - python3 scripts/ci_benchmark.py --output current_perf.json
#    - |
#      if [ -n "$CI_MERGE_REQUEST_IID" ]; then
#        python3 scripts/ci_compare_performance.py baseline_perf.json current_perf.json > perf_comparison.json
#        python3 scripts/ci_post_performance_comment.py perf_comparison.json
#      fi
#  artifacts:
#    name: "performance-comparison-$CI_COMMIT_REF_SLUG"
#    paths:
#      - current_perf.json
#      - perf_comparison.json
#    expire_in: 1 week
#  only:
#    - merge_requests
#  allow_failure: true
#
#report:summary:
#  image: rust:1.92-bookworm
#  stage: report
#  dependencies:
#    - rust:build-test-lint
#    - coverage
#    - docker:verify
#    - performance:compare
#  before_script:
#    - rustc --version
#    - cargo --version
#    - apt-get update -qq
#  script:
#    - python3 scripts/ci_generate_summary_report.py > pipeline_summary.md
#    - python3 scripts/ci_post_summary_comment.py pipeline_summary.md
#  artifacts:
#    name: "pipeline-summary-$CI_COMMIT_REF_SLUG"
#    paths:
#      - pipeline_summary.md
#    expire_in: 1 month
#  when: always
#  only:
#    - merge_requests
